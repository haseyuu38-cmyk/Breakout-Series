<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>ちっくゲーム - Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* --- 全体レイアウト --- */
        body { 
            margin: 0; padding: 0; background-color: #fce4ec; 
            font-family: sans-serif; display: flex; flex-direction: column; 
            align-items: center; justify-content: flex-start; min-height: 100vh;
            touch-action: none; overflow-x: hidden;
        }

        /* --- ヘッダー(TIME) --- */
        #game-header { 
            width: 100%; height: 50px; display: none; 
            justify-content: center; align-items: center; margin-top: 5px;
        }
        #timer-box { background: #ad1457; color: white; padding: 5px 25px; border-radius: 20px; font-weight: bold; font-size: 20px; }

        /* --- 画面コンテナ --- */
        .content-frame {
            width: 95%; max-width: 480px; margin: 10px auto 0 auto;
            position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            border-radius: 10px; overflow: hidden; background: #fff;
        }

        /* 縦長画面 (Top / Select) */
        #portrait-frame { aspect-ratio: 2 / 3; display: block; }
        
        /* 横長画面 (Game Canvas) */
        #landscape-frame { aspect-ratio: 3 / 2; display: none; }

        .full-asset { width: 100%; height: 100%; object-fit: contain; display: block; }
        canvas { width: 100%; height: 100%; display: block; }

        /* --- タップ判定エリア --- */
        .hit-area { position: absolute; cursor: pointer; z-index: 10; }

        /* --- ボタンエリア --- */
        #ui-control-panel { 
            width: 90%; max-width: 480px; text-align: center;
            padding-top: 5px; 
        }
        .action-btn { 
            display: block; width: 100%; padding: 16px; margin: 10px 0; 
            background: #ad1457; color: white; border: none; border-radius: 15px; 
            font-size: 18px; font-weight: bold; box-shadow: 0 4px 0 #78002e;
            cursor: pointer; -webkit-tap-highlight-color: transparent;
        }
        .action-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #78002e; }
    </style>
</head>
<body>

<div id="game-header">
    <div id="timer-box">TIME: 00:00</div>
</div>

<div id="portrait-frame" class="content-frame">
    <div id="screen-top" style="width:100%; height:100%; position:relative;">
        <img src="Top.png" class="full-asset" alt="Top">
        <div class="hit-area" style="top:60%; left:15%; width:70%; height:20%;" onclick="toSelect()"></div>
    </div>
    <div id="screen-select" style="width:100%; height:100%; position:relative; display:none;">
        <img src="Select.png" class="full-asset" alt="Select">
        <div class="hit-area" style="top:25%; left:10%; width:80%; height:15%;" onclick="toBreakout()"></div>
    </div>
</div>

<div id="landscape-frame" class="content-frame">
    <canvas id="gameCanvas" width="480" height="320"></canvas>
</div>

<div id="ui-control-panel">
    <div id="controls-miss" style="display:none;">
        <button class="action-btn" onclick="retryBreakout()">あきらめない！</button>
        <button class="action-btn" style="background:#ad1457; box-shadow:0 4px 0 #78002e;" onclick="toBreakout()">最初からやり直す</button>
        <button class="action-btn" style="background:#e91e63; box-shadow:0 4px 0 #c2185b;" onclick="backToSelect()">Game selection</button>
    </div>
    <div id="controls-win" style="display:none;">
        <button class="action-btn" onclick="toBreakout()">もう一度遊ぶ</button>
        <button class="action-btn" style="background:#e91e63; box-shadow:0 4px 0 #c2185b;" onclick="backToSelect()">Game selection</button>
    </div>
</div>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const header = document.getElementById("game-header");
    const timerBox = document.getElementById("timer-box");
    
    const pFrame = document.getElementById("portrait-frame");
    const lFrame = document.getElementById("landscape-frame");
    const sTop = document.getElementById("screen-top");
    const sSelect = document.getElementById("screen-select");
    
    const cMiss = document.getElementById("controls-miss");
    const cWin = document.getElementById("controls-win");

    let ballRadius = 10;
    let x, y, dx, dy, paddleX, score, startTime, totalPaused, pauseStart;
    let paddleWidth = 80;
    let bricks = [];
    let gameState = "TOP";
    let lastTouchX = null;

    let speedMultiplier = 1.0;
    const MAX_SPEED = 2.0;
    const ACCEL = 0.00015;

    const imgWin = new Image(); imgWin.src = 'Image.png';
    const imgMiss = new Image(); imgMiss.src = 'Miss.png';

    // --- 遷移処理 ---
    function toSelect() {
        sTop.style.display = "none";
        sSelect.style.display = "block";
        gameState = "SELECT";
    }

    // ゲームを最初から開始（初期化して実行）
    function toBreakout() {
        pFrame.style.display = "none";
        cMiss.style.display = "none";
        cWin.style.display = "none";
        
        lFrame.style.display = "block";
        header.style.display = "flex";
        
        initGame();
        startTime = Date.now();
        gameState = "PLAY";
        draw();
    }

    function backToSelect() {
        lFrame.style.display = "none";
        header.style.display = "none";
        cWin.style.display = "none";
        cMiss.style.display = "none"; // 失敗画面からの戻りも考慮
        
        pFrame.style.display = "block";
        sSelect.style.display = "block";
        gameState = "SELECT";
    }

    // 失敗した場所から再開（コンテニュー）
    function retryBreakout() {
        cMiss.style.display = "none";
        x = canvas.width/2; y = canvas.height-30;
        dx = 2.5; dy = -2.5;
        speedMultiplier = 1.0;
        totalPaused += (Date.now() - pauseStart);
        gameState = "PLAY";
        draw();
    }

    function initGame() {
        x = canvas.width/2; y = canvas.height-30;
        dx = 2.5; dy = -2.5;
        speedMultiplier = 1.0;
        paddleX = (canvas.width - paddleWidth) / 2;
        score = 0; totalPaused = 0;
        bricks = [];
        for(let c=0; c<5; c++) {
            bricks[c] = [];
            for(let r=0; r<3; r++) { bricks[c][r] = { x: 0, y: 0, status: 1 }; }
        }
    }

    // --- 操作系 ---
    function handleMove(clientX) {
        if (gameState !== "PLAY") return;
        const rect = canvas.getBoundingClientRect();
        const scale = canvas.width / rect.width;
        if (lastTouchX !== null) {
            let moveX = (clientX - lastTouchX) * scale;
            paddleX = Math.max(0, Math.min(canvas.width - paddleWidth, paddleX + moveX));
        }
        lastTouchX = clientX;
    }

    window.addEventListener("touchstart", (e) => { lastTouchX = e.touches[0].clientX; }, {passive: false});
    window.addEventListener("touchmove", (e) => { e.preventDefault(); handleMove(e.touches[0].clientX); }, {passive: false});
    window.addEventListener("touchend", () => { lastTouchX = null; });

    // --- メインループ ---
    function draw() {
        if (gameState !== "PLAY") return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (speedMultiplier < MAX_SPEED) speedMultiplier += ACCEL;

        for(let c=0; c<5; c++) {
            for(let r=0; r<3; r++) {
                let b = bricks[c][r];
                if(b.status === 1) {
                    let bx = (c * 85) + 30;
                    let by = (r * 30) + 30;
                    b.x = bx; b.y = by;
                    ctx.fillStyle = "#f06292";
                    ctx.fillRect(bx, by, 75, 20);
                    
                    if(x > bx && x < bx + 75 && y > by && y < by + 20) {
                        dy = -dy; b.status = 0; score++;
                        if(score === 15) {
                            gameState = "WIN";
                            cWin.style.display = "block";
                        }
                    }
                }
            }
        }

        ctx.beginPath(); ctx.arc(x, y, ballRadius, 0, Math.PI*2); ctx.fillStyle = "#ff4081"; ctx.fill(); ctx.closePath();
        ctx.fillStyle = "#ad1457"; ctx.fillRect(paddleX, canvas.height - 10, paddleWidth, 10);

        let elapsed = Math.floor((Date.now() - startTime - totalPaused) / 1000);
        timerBox.innerText = `TIME: ${Math.floor(elapsed/60).toString().padStart(2,'0')}:${(elapsed%60).toString().padStart(2,'0')}`;

        if(x + dx > canvas.width - ballRadius || x + dx < ballRadius) dx = -dx;
        if(y + dy < ballRadius) dy = -dy;
        else if(y + dy > canvas.height - ballRadius) {
            if(x > paddleX && x < paddleX + paddleWidth) dy = -Math.abs(dy);
            else {
                gameState = "MISS";
                pauseStart = Date.now();
                cMiss.style.display = "block";
            }
        }

        if (gameState === "PLAY") {
            x += dx * speedMultiplier; y += dy * speedMultiplier;
            requestAnimationFrame(draw);
        } else if (gameState === "MISS") {
            ctx.drawImage(imgMiss, 0, 0, 480, 320);
        } else if (gameState === "WIN") {
            ctx.drawImage(imgWin, 0, 0, 480, 320);
        }
    }
</script>
</body>
</html>
