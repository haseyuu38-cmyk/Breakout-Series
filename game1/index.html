<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>ちっくゲーム - Complete Stable</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    margin:0;
    padding:0;
    background:#fce4ec;
    font-family:sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
    min-height:100vh;
    overflow:hidden;
}

.content-frame{
    width:95%;
    max-width:480px;
    margin-top:10px;
    position:relative;
    border-radius:10px;
    overflow:hidden;
    background:#fff;
}

#landscape-frame{ aspect-ratio:3/2; display:none; }

canvas{
    width:100%;
    height:100%;
    display:block;
    background:#fff;
    touch-action:none; /* ← ここ重要 */
}

#ui-control-panel{
    width:90%;
    max-width:480px;
    text-align:center;
}

.action-btn{
    width:100%;
    padding:16px;
    margin:10px 0;
    border:none;
    border-radius:15px;
    font-size:18px;
    font-weight:bold;
    color:white;
    position:relative;
    z-index:9999;
}

.btn-main{background:#ad1457;}
.btn-light{background:#f06292;}
.btn-deep{background:#e91e63;}
</style>
</head>

<body>

<div id="landscape-frame" class="content-frame">
    <canvas id="gameCanvas" width="480" height="320"></canvas>
</div>

<div id="ui-control-panel">
    <div id="controls-miss" style="display:none;">
        <button class="action-btn btn-main" onclick="retryBreakout()">あきらめない！</button>
        <button class="action-btn btn-light" onclick="startGame()">最初からやり直す</button>
    </div>
</div>

<script>
const canvas=document.getElementById("gameCanvas");
const ctx=canvas.getContext("2d");
const cMiss=document.getElementById("controls-miss");

let gameState="PLAY";
let animId=null;

const ballRadius=10;
const paddleWidth=80;

let x,y,dx,dy,paddleX;

function startGame(){
    cancelAnimationFrame(animId);
    cMiss.style.display="none";
    gameState="PLAY";
    x=canvas.width/2;
    y=canvas.height-30;
    dx=3;
    dy=-3;
    paddleX=(canvas.width-paddleWidth)/2;
    draw();
}

function retryBreakout(){
    startGame();
}

function draw(){
    if(gameState!=="PLAY") return;

    ctx.clearRect(0,0,canvas.width,canvas.height);

    // ボール
    ctx.beginPath();
    ctx.arc(x,y,ballRadius,0,Math.PI*2);
    ctx.fillStyle="#ff4081";
    ctx.fill();
    ctx.closePath();

    // パドル
    ctx.fillStyle="#ad1457";
    ctx.fillRect(paddleX,canvas.height-10,paddleWidth,10);

    if(x+dx>canvas.width-ballRadius||x+dx<ballRadius) dx=-dx;
    if(y+dy<ballRadius) dy=-dy;
    else if(y+dy>canvas.height-ballRadius){
        if(x>paddleX&&x<paddleX+paddleWidth){
            dy=-Math.abs(dy);
        }else{
            gameState="MISS";
            cMiss.style.display="block";
            return;
        }
    }

    x+=dx;
    y+=dy;

    animId=requestAnimationFrame(draw);
}

/* ===== 操作（canvas限定で安全） ===== */

let lastX=null;
let isDragging=false;

function handleMove(clientX){
    const rect=canvas.getBoundingClientRect();
    const scale=canvas.width/rect.width;

    if(lastX!==null){
        let move=(clientX-lastX)*scale;
        paddleX=Math.max(0,Math.min(canvas.width-paddleWidth,paddleX+move));
    }
    lastX=clientX;
}

canvas.addEventListener("mousedown",e=>{
    if(gameState!=="PLAY") return;
    isDragging=true;
    lastX=e.clientX;
});

window.addEventListener("mousemove",e=>{
    if(!isDragging) return;
    handleMove(e.clientX);
});

window.addEventListener("mouseup",()=>{
    isDragging=false;
    lastX=null;
});

canvas.addEventListener("touchstart",e=>{
    if(gameState!=="PLAY") return;
    lastX=e.touches[0].clientX;
},{passive:true});

canvas.addEventListener("touchmove",e=>{
    if(gameState!=="PLAY") return;
    handleMove(e.touches[0].clientX);
},{passive:true});

canvas.addEventListener("touchend",()=>{
    lastX=null;
});

document.getElementById("landscape-frame").style.display="block";
startGame();
</script>

</body>
</html>
