<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>ちっくゲーム - Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { 
            margin: 0; padding: 0; background-color: #fce4ec; 
            font-family: sans-serif; display: flex; flex-direction: column; 
            align-items: center; justify-content: flex-start; min-height: 100vh;
            touch-action: none; overflow: hidden;
        }
        #header-area { 
            width: 100%; height: 50px; display: none; 
            justify-content: center; align-items: center; margin-top: 5px;
        }
        #timer-box { background: #ad1457; color: white; padding: 4px 20px; border-radius: 20px; font-weight: bold; font-size: 20px; }

        #canvas-container { 
            width: 95%; max-width: 400px; margin: 5px auto; position: relative; 
            aspect-ratio: 2/3; /* 縦長比率を維持 */
        }
        canvas { 
            background: #ffffff; display: block; width: 100%; height: auto; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 10px;
        }

        #ui-area { 
            width: 90%; max-width: 400px; text-align: center; 
            margin-top: -10px; /* ボタンを画像に近づける */
            z-index: 200;
        }
        .btn { 
            display: block; width: 100%; padding: 15px; margin: 8px 0; 
            background: #ad1457; color: white; border: none; border-radius: 15px; 
            font-size: 18px; font-weight: bold; box-shadow: 0 4px 0 #78002e;
            cursor: pointer; -webkit-tap-highlight-color: transparent;
        }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #78002e; }

        .screen-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; display: none; background: #fff; border-radius: 10px;
        }
        .full-img { width: 100%; height: 100%; object-fit: contain; display: block; }
        .hit-area { position: absolute; cursor: pointer; z-index: 110; }
    </style>
</head>
<body>

<div id="header-area">
    <div id="timer-box">TIME: 00:00</div>
</div>

<div id="canvas-container">
    <div id="top-screen" class="screen-overlay" style="display: block;">
        <img src="Top.png" class="full-img" alt="Top">
        <div id="go-select-hit" class="hit-area" style="top: 65%; left: 15%; width: 70%; height: 15%;" onclick="showSelect()"></div>
    </div>

    <div id="select-screen" class="screen-overlay">
        <img src="Select.png" class="full-img" alt="Select">
        <div id="start-breakout-hit" class="hit-area" style="top: 28%; left: 10%; width: 80%; height: 12%;" onclick="startBreakout()"></div>
    </div>
    
    <canvas id="myCanvas" width="480" height="720" style="display: none;"></canvas>
</div>

<div id="ui-area">
    <div id="miss-controls" style="display:none;">
        <button class="btn" onclick="continueGame()">あきらめない！</button>
        <button class="btn" style="background:#666; box-shadow:0 4px 0 #333;" onclick="restartGame()">最初からやり直す</button>
    </div>
    
    <div id="win-controls" style="display:none;">
        <button class="btn" onclick="startBreakout()">もう一度遊ぶ</button>
        <button class="btn" style="background:#e91e63; box-shadow:0 4px 0 #c2185b;" onclick="showSelect()">Game selection</button>
    </div>
</div>

<script>
    var canvas = document.getElementById("myCanvas");
    var ctx = canvas.getContext("2d");
    var timerBox = document.getElementById("timer-box");
    var headerArea = document.getElementById("header-area");
    var missControls = document.getElementById("miss-controls");
    var winControls = document.getElementById("win-controls");
    var topScreen = document.getElementById("top-screen");
    var selectScreen = document.getElementById("select-screen");

    var ballRadius = 12;
    var x, y, dx, dy, paddleX, score, startTime, totalPaused, pauseStart;
    var paddleWidth = 90;
    var bricks = [];
    var winImg = new Image(); winImg.src = 'Image.png';
    var missImg = new Image(); missImg.src = 'Miss.png';
    var gameState = "top";
    var lastTouchX = null;

    var speedMultiplier = 1.0;
    const MAX_SPEED_MULTIPLIER = 2.2;
    const SPEED_INCREMENT = 0.00015;

    function showSelect() {
        topScreen.style.display = "none";
        canvas.style.display = "none";
        headerArea.style.display = "none";
        winControls.style.display = "none";
        missControls.style.display = "none";
        selectScreen.style.display = "block";
        gameState = "select";
    }

    function startBreakout() {
        selectScreen.style.display = "none";
        winControls.style.display = "none";
        missControls.style.display = "none";
        canvas.style.display = "block";
        headerArea.style.display = "flex";
        init();
        startTime = Date.now();
        gameState = "play";
        draw();
    }

    function init() {
        x = canvas.width/2; y = canvas.height-50;
        dx = 3; dy = -3;
        speedMultiplier = 1.0;
        paddleX = (canvas.width-paddleWidth)/2;
        score = 0; totalPaused = 0;
        for(var c=0; c<5; c++) {
            bricks[c] = [];
            for(var r=0; r<4; r++) { bricks[c][r] = { x: 0, y: 0, status: 1 }; }
        }
    }

    function continueGame() {
        x = canvas.width/2; y = canvas.height-50;
        dx = 3; dy = -3;
        speedMultiplier = 1.0;
        totalPaused += (Date.now() - pauseStart);
        gameState = "play";
        missControls.style.display = "none";
        draw(); 
    }

    function restartGame() { location.reload(); }

    function handleMove(currentClientX) {
        if (gameState !== "play") return;
        var rect = canvas.getBoundingClientRect();
        var scale = canvas.width / rect.width;
        if (lastTouchX !== null) {
            var movementX = (currentClientX - lastTouchX) * scale;
            paddleX += movementX;
            if (paddleX < 0) paddleX = 0;
            if (paddleX > canvas.width - paddleWidth) paddleX = canvas.width - paddleWidth;
        }
        lastTouchX = currentClientX;
    }

    window.addEventListener("touchstart", function(e) { lastTouchX = e.touches[0].clientX; }, {passive: false});
    window.addEventListener("touchmove", function(e) { e.preventDefault(); handleMove(e.touches[0].clientX); }, {passive: false});
    window.addEventListener("touchend", function() { lastTouchX = null; });

    function draw() {
        if(gameState === "play") {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (speedMultiplier < MAX_SPEED_MULTIPLIER) { speedMultiplier += SPEED_INCREMENT; }

            for(var c=0; c<5; c++) {
                for(var r=0; r<4; r++) {
                    var b = bricks[c][r];
                    if(b.status == 1) {
                        var bx = (c*(80+10))+20; var by = (r*(25+10))+60;
                        b.x = bx; b.y = by;
                        ctx.fillStyle = "#f06292"; ctx.fillRect(bx, by, 80, 25);
                    }
                }
            }
            ctx.beginPath(); ctx.arc(x, y, ballRadius, 0, Math.PI*2); ctx.fillStyle = "#ff4081"; ctx.fill(); ctx.closePath();
            ctx.fillStyle = "#ad1457"; ctx.fillRect(paddleX, canvas.height-20, paddleWidth, 15);

            var msec = Date.now() - startTime - totalPaused;
            var s = Math.floor(msec/1000);
            timerBox.innerText = "TIME: " + Math.floor(s/60).toString().padStart(2,'0') + ":" + (s%60).toString().padStart(2,'0');

            for(var c=0; c<5; c++) {
                for(var r=0; r<4; r++) {
                    var b = bricks[c][r];
                    if(b.status == 1 && x > b.x && x < b.x+80 && y > b.y && y < b.y+25) {
                        dy = -dy; b.status = 0; score++;
                        if(score == 20) { 
                            gameState = "win"; 
                            winControls.style.display = "block"; 
                        }
                    }
                }
            }

            if(x + dx > canvas.width-ballRadius || x + dx < ballRadius) dx = -dx;
            if(y + dy < ballRadius) dy = -dy;
            else if(y + dy > canvas.height-ballRadius) {
                if(x > paddleX && x < paddleX + paddleWidth) { dy = -Math.abs(dy); }
                else {
                    gameState = "miss"; pauseStart = Date.now();
                    missControls.style.display = "block";
                }
            }
            x += dx * speedMultiplier; y += dy * speedMultiplier;
            requestAnimationFrame(draw);
        } else if(gameState === "miss") {
            ctx.drawImage(missImg, 0, 0, canvas.width, canvas.height);
        } else if(gameState === "win") {
            ctx.drawImage(winImg, 0, 0, canvas.width, canvas.height);
        }
    }
</script>
</body>
</html>
