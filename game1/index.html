<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>ちっくゲーム - Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { 
            margin: 0; padding: 0; background-color: #fce4ec; 
            font-family: sans-serif; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; min-height: 100vh;
            touch-action: none; overflow: hidden;
        }
        #header-area { 
            width: 100%; height: 60px; display: none; 
            justify-content: center; align-items: center; 
        }
        #timer-box { background: #ad1457; color: white; padding: 5px 25px; border-radius: 20px; font-weight: bold; font-size: 22px; }

        #canvas-container { width: 95%; max-width: 480px; margin: 10px 0; position: relative; aspect-ratio: 2/3; }
        canvas { background: #ffffff; display: block; width: 100%; height: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

        #ui-area { 
            width: 90%; max-width: 480px; text-align: center; 
            min-height: 160px; display: flex; flex-direction: column; justify-content: center;
        }
        .message { font-size: 20px; font-weight: bold; color: #ad1457; margin-bottom: 10px; height: 30px; }
        .btn { 
            display: block; width: 100%; padding: 18px; margin: 8px 0; 
            background: #ad1457; color: white; border: none; border-radius: 15px; 
            font-size: 18px; font-weight: bold; box-shadow: 0 4px 0 #78002e;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #78002e; }

        .screen-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; display: none; background: #fff;
        }
        .full-img { width: 100%; height: 100%; object-fit: contain; display: block; }
        .hit-area { position: absolute; cursor: pointer; z-index: 110; }
    </style>
</head>
<body>

<div id="header-area">
    <div id="timer-box">TIME: 00:00</div>
</div>

<div id="canvas-container">
    <div id="top-screen" class="screen-overlay" style="display: block;">
        <img src="Top.png" class="full-img" alt="Top">
        <div id="go-select-hit" class="hit-area" style="top: 68%; left: 20%; width: 60%; height: 10%;" onclick="showSelect()"></div>
    </div>

    <div id="select-screen" class="screen-overlay">
        <img src="Select.png" class="full-img" alt="Select">
        <div id="start-breakout-hit" class="hit-area" style="top: 30%; left: 15%; width: 70%; height: 10%;" onclick="startBreakout()"></div>
    </div>
    
    <canvas id="myCanvas" width="480" height="320" style="display: none;"></canvas>
</div>

<div id="ui-area">
    <div id="msg" class="message"></div>
    
    <div id="miss-controls" style="display:none;">
        <button class="btn" onclick="continueGame()">あきらめない！</button>
        <button class="btn" style="background:#666; box-shadow:0 4px 0 #333;" onclick="restartGame()">最初からやり直す</button>
    </div>
    
    <div id="win-controls" style="display:none;">
        <button class="btn" onclick="startBreakout()">もう一度遊ぶ</button>
        <button class="btn" style="background:#e91e63; box-shadow:0 4px 0 #c2185b;" onclick="showSelect()">Game selection</button>
    </div>
</div>

<script>
    var canvas = document.getElementById("myCanvas");
    var ctx = canvas.getContext("2d");
    var msg = document.getElementById("msg");
    var timerBox = document.getElementById("timer-box");
    var headerArea = document.getElementById("header-area");
    var missControls = document.getElementById("miss-controls");
    var winControls = document.getElementById("win-controls");
    
    var topScreen = document.getElementById("top-screen");
    var selectScreen = document.getElementById("select-screen");

    var ballRadius = 10;
    var x, y, dx, dy, paddleX, score, startTime, totalPaused, pauseStart;
    
    var speedMultiplier = 1.0;
    const MAX_SPEED_MULTIPLIER = 2.0;
    const SPEED_INCREMENT = 0.00015;
    
    var paddleWidth = 75;
    var bricks = [];
    var winImg = new Image(); winImg.src = 'Image.png';
    var missImg = new Image(); missImg.src = 'Miss.png';
    var gameState = "top";
    var lastTouchX = null;

    // --- 画面遷移管理 ---
    function showSelect() {
        topScreen.style.display = "none";
        canvas.style.display = "none";
        headerArea.style.display = "none";
        winControls.style.display = "none";
        missControls.style.display = "none";
        msg.innerText = "";
        
        selectScreen.style.display = "block";
        gameState = "select";
    }

    function startBreakout() {
        selectScreen.style.display = "none";
        winControls.style.display = "none";
        missControls.style.display = "none";
        canvas.style.display = "block";
        headerArea.style.display = "flex";
        init();
        startTime = Date.now();
        gameState = "play";
        msg.innerText = "がんばって！";
        draw();
    }

    // --- ゲーム初期化 ---
    function init() {
        x = canvas.width/2; y = canvas.height-30;
        dx = 2; dy = -2;
        speedMultiplier = 1.0;
        paddleX = (canvas.width-paddleWidth)/2;
        score = 0; totalPaused = 0;
        for(var c=0; c<5; c++) {
            bricks[c] = [];
            for(var r=0; r<3; r++) { bricks[c][r] = { x: 0, y: 0, status: 1 }; }
        }
    }

    // --- 「あきらめない！」：続きからプレイ ---
    function continueGame() {
        x = canvas.width/2; 
        y = canvas.height-30;
        dx = 2; 
        dy = -2;
        speedMultiplier = 1.0; // 加速は一度リセットして遊びやすく
        totalPaused += (Date.now() - pauseStart);
        gameState = "play";
        missControls.style.display = "none";
        msg.innerText = "がんばって！";
        draw(); 
    }

    function restartGame() { location.reload(); }

    // --- 操作系（相対移動） ---
    function handleMove(currentClientX) {
        if (gameState !== "play") return;
        if (lastTouchX !== null) {
            var rect = canvas.getBoundingClientRect();
            var scale = canvas.width / rect.width;
            var movementX = (currentClientX - lastTouchX) * scale;
            paddleX += movementX;
            if (paddleX < 0) paddleX = 0;
            if (paddleX > canvas.width - paddleWidth) paddleX = canvas.width - paddleWidth;
        }
        lastTouchX = currentClientX;
    }

    window.addEventListener("mousedown", function(e) { lastTouchX = e.clientX; });
    window.addEventListener("mousemove", function(e) { if(e.buttons > 0) handleMove(e.clientX); });
    window.addEventListener("mouseup", function() { lastTouchX = null; });
    window.addEventListener("touchstart", function(e) { lastTouchX = e.touches[0].clientX; }, {passive: false});
    window.addEventListener("touchmove", function(e) { e.preventDefault(); handleMove(e.touches[0].clientX); }, {passive: false});
    window.addEventListener("touchend", function() { lastTouchX = null; });

    // --- メインループ ---
    function draw() {
        if(gameState === "play") {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (speedMultiplier < MAX_SPEED_MULTIPLIER) { speedMultiplier += SPEED_INCREMENT; }

            // ブロック描画
            for(var c=0; c<5; c++) {
                for(var r=0; r<3; r++) {
                    var b = bricks[c][r];
                    if(b.status == 1) {
                        var bx = (c*(75+10))+30; var by = (r*(20+10))+30;
                        b.x = bx; b.y = by;
                        ctx.fillStyle = "#f06292"; ctx.fillRect(bx, by, 75, 20);
                    }
                }
            }
            
            // ボール描画
            ctx.beginPath(); ctx.arc(x, y, ballRadius, 0, Math.PI*2); ctx.fillStyle = "#ff4081"; ctx.fill(); ctx.closePath();
            // パドル描画
            ctx.fillStyle = "#ad1457"; ctx.fillRect(paddleX, canvas.height-10, paddleWidth, 10);

            // タイム更新
            var msec = Date.now() - startTime - totalPaused;
            var s = Math.floor(msec/1000);
            timerBox.innerText = "TIME: " + Math.floor(s/60).toString().padStart(2,'0') + ":" + (s%60).toString().padStart(2,'0');

            // 衝突判定
            for(var c=0; c<5; c++) {
                for(var r=0; r<3; r++) {
                    var b = bricks[c][r];
                    if(b.status == 1 && x > b.x && x < b.x+75 && y > b.y && y < b.y+20) {
                        dy = -dy; b.status = 0; score++;
                        if(score == 15) { 
                            gameState = "win"; 
                            winControls.style.display = "block"; 
                            msg.innerText = ""; 
                        }
                    }
                }
            }

            // 壁バウンド
            if(x + dx > canvas.width-ballRadius || x + dx < ballRadius) dx = -dx;
            if(y + dy < ballRadius) dy = -dy;
            else if(y + dy > canvas.height-ballRadius) {
                if(x > paddleX && x < paddleX + paddleWidth) { 
                    dy = -Math.abs(dy); 
                } else {
                    // ミス時の挙動
                    gameState = "miss"; 
                    pauseStart = Date.now();
                    msg.innerText = ""; 
                    missControls.style.display = "block";
                    ctx.drawImage(missImg, 0, 0, 480, 320); 
                    return; 
                }
            }
            
            x += dx * speedMultiplier; 
            y += dy * speedMultiplier;
            requestAnimationFrame(draw);
        } else if(gameState === "miss") { 
            ctx.drawImage(missImg, 0, 0, 480, 320); 
        } else if(gameState === "win") { 
            ctx.drawImage(winImg, 0, 0, 480, 320); 
        }
    }
</script>
</body>
</html>
