<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>ちっくゲーム - Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* --- 全体レイアウト --- */
        body { 
            margin: 0; padding: 0; background-color: #fce4ec; 
            font-family: sans-serif; display: flex; flex-direction: column; 
            align-items: center; justify-content: flex-start; min-height: 100vh;
            touch-action: none; overflow-x: hidden;
        }

        /* --- ヘッダー(TIME) --- */
        #game-header { 
            width: 100%; height: 50px; display: none; 
            justify-content: center; align-items: center; margin-top: 5px;
        }
        #timer-box { background: #ad1457; color: white; padding: 5px 25px; border-radius: 20px; font-weight: bold; font-size: 20px; }

        /* --- 画面コンテナ --- */
        .content-frame {
            width: 95%; max-width: 480px; margin: 10px auto 0 auto;
            position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            border-radius: 10px; overflow: hidden; background: transparent;
        }

        /* 縦長画面 (Top / Select) */
        #portrait-frame { aspect-ratio: 2 / 3; display: block; }
        /* 横長画面 (Breakout) */
        #landscape-frame { aspect-ratio: 3 / 2; display: none; }
        /* 正方形画面 (9 Puzzle) */
        #puzzle-frame { aspect-ratio: 1 / 1; display: none; background: #fff; }

        .full-asset { width: 100%; height: 100%; object-fit: cover; display: block; }
        canvas { width: 100%; height: 100%; display: block; background: #fff; }

        /* --- 9パズル用スタイル --- */
        #puzzle-board {
            display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr);
            width: 100%; height: 100%; gap: 1px; background: #333;
        }
        .tile {
            width: 100%; height: 100%; background-image: url("image-3.jpg");
            background-size: 300% 300%; background-repeat: no-repeat;
        }
        .empty { background: #eee !important; background-image: none !important; }

        /* --- タップ判定エリア --- */
        .hit-area { position: absolute; cursor: pointer; z-index: 10; }

        /* --- ボタンエリア --- */
        #ui-control-panel { width: 90%; max-width: 480px; text-align: center; padding-top: 5px; }
        .action-btn { 
            display: block; width: 100%; padding: 16px; margin: 10px 0; 
            color: white; border: none; border-radius: 15px; font-size: 18px; font-weight: bold; 
            cursor: pointer; -webkit-tap-highlight-color: transparent;
        }
        .action-btn:active { transform: translateY(2px); opacity: 0.9; }

        .btn-main { background: #ad1457; box-shadow: 0 4px 0 #78002e; }
        .btn-light { background: #f06292; box-shadow: 0 4px 0 #ad1457; }
        .btn-deep { background: #e91e63; box-shadow: 0 4px 0 #c2185b; }
        .btn-sub { background: #888; box-shadow: 0 4px 0 #555; }
        .btn-puzzle { background: #28a745; box-shadow: 0 4px 0 #1e7e34; }
    </style>
</head>
<body>

<div id="game-header">
    <div id="timer-box">TIME: 00:00</div>
</div>

<div id="portrait-frame" class="content-frame">
    <div id="screen-top" style="width:100%; height:100%; position:relative;">
        <img src="Top.png" class="full-asset" alt="Top">
        <div class="hit-area" style="top:60%; left:15%; width:70%; height:20%;" onclick="toSelect()"></div>
    </div>
    <div id="screen-select" style="width:100%; height:100%; position:relative; display:none;">
        <img src="Select.png" class="full-asset" alt="Select">
        <div class="hit-area" style="top:25%; left:10%; width:80%; height:15%;" onclick="toBreakout()"></div>
        <div class="hit-area" style="top:42%; left:10%; width:80%; height:15%;" onclick="toPuzzle()"></div>
    </div>
</div>

<div id="landscape-frame" class="content-frame">
    <canvas id="gameCanvas" width="480" height="320"></canvas>
</div>

<div id="puzzle-frame" class="content-frame">
    <div id="puzzle-board"></div>
</div>

<div id="ui-control-panel">
    <button id="puzzle-start-btn" class="action-btn btn-puzzle" style="display:none;" onclick="shufflePuzzle()">シャッフルして開始！</button>
    
    <div id="controls-miss" style="display:none;">
        <button class="action-btn btn-main" onclick="retryBreakout()">あきらめない！</button>
        <button class="action-btn btn-light" onclick="toBreakout()">最初からやり直す</button>
        <button class="action-btn btn-deep" onclick="backToSelect()">Game selection</button>
    </div>
    
    <div id="controls-win" style="display:none;">
        <button id="win-retry-btn" class="action-btn btn-main" onclick="">もう一度遊ぶ</button>
        <button class="action-btn btn-deep" onclick="backToSelect()">Game selection</button>
        <button class="action-btn btn-sub" onclick="location.reload()">タイトルに戻る</button>
    </div>
</div>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const header = document.getElementById("game-header");
    const timerBox = document.getElementById("timer-box");
    const pFrame = document.getElementById("portrait-frame");
    const lFrame = document.getElementById("landscape-frame");
    const pzFrame = document.getElementById("puzzle-frame");
    const sTop = document.getElementById("screen-top");
    const sSelect = document.getElementById("screen-select");
    const cMiss = document.getElementById("controls-miss");
    const cWin = document.getElementById("controls-win");
    const pzStartBtn = document.getElementById("puzzle-start-btn");
    const winRetryBtn = document.getElementById("win-retry-btn");

    let gameState = "TOP";
    let startTime, timerId, totalPaused, pauseStart;

    // --- ブロック崩し用変数 ---
    let ballRadius = 10, x, y, dx, dy, paddleX, score, paddleWidth = 80, bricks = [];
    let speedMultiplier = 1.0;
    const imgWin = new Image(); imgWin.src = 'Image.png';
    const imgMiss = new Image(); imgMiss.src = 'Miss.png';

    // --- 9パズル用変数 ---
    let tiles = [1, 2, 3, 4, 5, 6, 7, 8, null];
    let moveCount = 0;

    // --- 遷移処理 ---
    function toSelect() {
        sTop.style.display = "none";
        sSelect.style.display = "block";
        gameState = "SELECT";
    }

    function backToSelect() {
        lFrame.style.display = "none";
        pzFrame.style.display = "none";
        header.style.display = "none";
        cWin.style.display = "none";
        cMiss.style.display = "none";
        pzStartBtn.style.display = "none";
        pFrame.style.display = "block";
        sSelect.style.display = "block";
        gameState = "SELECT";
        if(timerId) clearInterval(timerId);
    }

    // --- ブロック崩し実行部 ---
    function toBreakout() {
        hideAllFrames();
        lFrame.style.display = "block";
        header.style.display = "flex";
        initBreakout();
        startGlobalTimer();
        gameState = "PLAY_BRK";
        winRetryBtn.onclick = toBreakout;
        drawBreakout();
    }

    function initBreakout() {
        x = canvas.width/2; y = canvas.height-30;
        dx = 2.5; dy = -2.5; speedMultiplier = 1.0;
        paddleX = (canvas.width - paddleWidth) / 2;
        score = 0; totalPaused = 0;
        bricks = [];
        for(let c=0; c<5; c++) {
            bricks[c] = [];
            for(let r=0; r<3; r++) { bricks[c][r] = { x: 0, y: 0, status: 1 }; }
        }
    }

    function retryBreakout() {
        cMiss.style.display = "none";
        x = canvas.width/2; y = canvas.height-30;
        dx = 2.5; dy = -2.5; speedMultiplier = 1.0;
        totalPaused += (Date.now() - pauseStart);
        gameState = "PLAY_BRK";
        drawBreakout();
    }

    // --- 9パズル実行部 ---
    function toPuzzle() {
        hideAllFrames();
        pzFrame.style.display = "block";
        header.style.display = "flex";
        pzStartBtn.style.display = "block";
        tiles = [1, 2, 3, 4, 5, 6, 7, 8, null];
        moveCount = 0;
        gameState = "PUZZLE_READY";
        winRetryBtn.onclick = toPuzzle;
        drawPuzzle();
        updateTimerDisplay(0);
    }

    function shufflePuzzle() {
        pzStartBtn.style.display = "none";
        moveCount = 0;
        for (let i = 0; i < 150; i++) {
            const e = tiles.indexOf(null);
            const m = [];
            if (e % 3 !== 0) m.push(e - 1);
            if (e % 3 !== 2) m.push(e + 1);
            if (e >= 3) m.push(e - 3);
            if (e < 6) m.push(e + 3);
            const t = m[Math.floor(Math.random() * m.length)];
            [tiles[e], tiles[t]] = [tiles[t], tiles[e]];
        }
        startGlobalTimer();
        gameState = "PLAY_PZL";
        drawPuzzle();
    }

    function drawPuzzle() {
        const board = document.getElementById("puzzle-board");
        board.innerHTML = "";
        tiles.forEach((n, i) => {
            const d = document.createElement("div");
            d.className = n === null ? "tile empty" : "tile";
            if (n !== null) {
                const xPos = (n - 1) % 3;
                const yPos = Math.floor((n - 1) / 3);
                d.style.backgroundPosition = (xPos * 50) + "% " + (yPos * 50) + "%";
                d.onclick = () => moveTile(i);
            }
            board.appendChild(d);
        });
    }

    function moveTile(i) {
        if (gameState !== "PLAY_PZL") return;
        const e = tiles.indexOf(null);
        const row = Math.floor(i / 3), col = i % 3;
        const er = Math.floor(e / 3), ec = e % 3;
        if (Math.abs(row - er) + Math.abs(col - ec) === 1) {
            [tiles[i], tiles[e]] = [tiles[e], tiles[i]];
            moveCount++;
            drawPuzzle();
            if (tiles.every((v, idx) => v === (idx === 8 ? null : idx + 1))) {
                clearInterval(timerId);
                gameState = "WIN_PZL";
                setTimeout(() => {
                    alert("クリアおめでとう！\n手数: " + moveCount + "回");
                    cWin.style.display = "block";
                }, 200);
            }
        }
    }

    // --- 共通ヘルパー ---
    function hideAllFrames() {
        pFrame.style.display = "none";
        lFrame.style.display = "none";
        pzFrame.style.display = "none";
        cMiss.style.display = "none";
        cWin.style.display = "none";
        pzStartBtn.style.display = "none";
    }

    function startGlobalTimer() {
        if (timerId) clearInterval(timerId);
        startTime = Date.now();
        totalPaused = 0;
        timerId = setInterval(() => {
            let elapsed = Math.floor((Date.now() - startTime - totalPaused) / 1000);
            updateTimerDisplay(elapsed);
        }, 1000);
    }

    function updateTimerDisplay(s) {
        timerBox.innerText = `TIME: ${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
    }

    // --- ブロック崩し描画ループ ---
    function drawBreakout() {
        if (gameState !== "PLAY_BRK") return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (speedMultiplier < 2.0) speedMultiplier += 0.00015;
        // ブロック・ボール・パドルの描画ロジック (中身は前回と同じ)
        for(let c=0; c<5; c++) {
            for(let r=0; r<3; r++) {
                let b = bricks[c][r];
                if(b.status === 1) {
                    let bx = (c * 85) + 30; let by = (r * 30) + 30;
                    b.x = bx; b.y = by;
                    ctx.fillStyle = "#f06292"; ctx.fillRect(bx, by, 75, 20);
                    if(x > bx && x < bx + 75 && y > by && y < by + 20) {
                        dy = -dy; b.status = 0; score++;
                        if(score === 15) { 
                            gameState = "WIN_BRK"; 
                            clearInterval(timerId);
                            cWin.style.display = "block"; 
                        }
                    }
                }
            }
        }
        ctx.beginPath(); ctx.arc(x, y, ballRadius, 0, Math.PI*2); ctx.fillStyle = "#ff4081"; ctx.fill(); ctx.closePath();
        ctx.fillStyle = "#ad1457"; ctx.fillRect(paddleX, canvas.height - 10, paddleWidth, 10);
        if(x + dx > canvas.width - ballRadius || x + dx < ballRadius) dx = -dx;
        if(y + dy < ballRadius) dy = -dy;
        else if(y + dy > canvas.height - ballRadius) {
            if(x > paddleX && x < paddleX + paddleWidth) dy = -Math.abs(dy);
            else { gameState = "MISS_BRK"; clearInterval(timerId); pauseStart = Date.now(); cMiss.style.display = "block"; }
        }
        if (gameState === "PLAY_BRK") {
            x += dx * speedMultiplier; y += dy * speedMultiplier;
            requestAnimationFrame(drawBreakout);
        } else if (gameState === "MISS_BRK") {
            ctx.drawImage(imgMiss, 0, 0, 480, 320);
        } else if (gameState === "WIN_BRK") {
            ctx.drawImage(imgWin, 0, 0, 480, 320);
        }
    }

    // --- 操作イベント (ブロック崩し用) ---
    function handleMove(clientX) {
        if (gameState !== "PLAY_BRK") return;
        const rect = canvas.getBoundingClientRect();
        const scale = canvas.width / rect.width;
        if (lastTouchX !== null) {
            let moveX = (clientX - lastTouchX) * scale;
            paddleX = Math.max(0, Math.min(canvas.width - paddleWidth, paddleX + moveX));
        }
        lastTouchX = clientX;
    }
    window.addEventListener("touchstart", (e) => { lastTouchX = e.touches[0].clientX; }, {passive: false});
    window.addEventListener("touchmove", (e) => { if(gameState==="PLAY_BRK") e.preventDefault(); handleMove(e.touches[0].clientX); }, {passive: false});
    window.addEventListener("touchend", () => { lastTouchX = null; });
</script>
</body>
</html>
