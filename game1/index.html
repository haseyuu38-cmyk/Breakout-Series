<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>Breakout Game Series</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { 
            margin: 0; padding: 0; background-color: #fce4ec; 
            font-family: sans-serif; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; min-height: 100vh;
            touch-action: none;
        }
        #header-area { width: 100%; height: 60px; display: flex; justify-content: center; align-items: center; }
        #timer-box { background: #ad1457; color: white; padding: 5px 25px; border-radius: 20px; font-weight: bold; font-size: 22px; }

        #canvas-container { width: 95%; max-width: 480px; margin: 10px 0; position: relative; }
        canvas { background: #ffffff; display: block; width: 100%; height: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

        #ui-area { width: 90%; max-width: 480px; text-align: center; }
        .message { font-size: 20px; font-weight: bold; color: #ad1457; margin-bottom: 10px; height: 30px; }
        .btn { 
            display: block; width: 100%; padding: 18px; margin: 10px 0; 
            background: #ad1457; color: white; border: none; border-radius: 15px; 
            font-size: 18px; font-weight: bold; box-shadow: 0 4px 0 #78002e;
            cursor: pointer;
        }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #78002e; }
    </style>
</head>
<body>

<div id="header-area">
    <div id="timer-box">TIME: 00:00</div>
</div>

<div id="canvas-container">
    <canvas id="myCanvas" width="480" height="320"></canvas>
</div>

<div id="ui-area">
    <div id="msg" class="message">TAP TO START</div>
    <button id="start-btn" class="btn" onclick="startGame()">ゲームを始める</button>
    
    <div id="miss-controls" style="display:none;">
        <button class="btn" onclick="continueGame()">あきらめない</button>
        <button class="btn" style="background:#666; box-shadow:0 4px 0 #333;" onclick="restartGame()">最初からやり直す</button>
    </div>

    <div id="win-controls" style="display:none;">
        <h2 style="color:#ad1457; margin-bottom:10px;">おめでとう〜♪</h2>
        <button class="btn" onclick="restartGame()">もう一度遊ぶ</button>
    </div>
</div>

<script>
    var canvas = document.getElementById("myCanvas");
    var ctx = canvas.getContext("2d");
    var msg = document.getElementById("msg");
    var timerBox = document.getElementById("timer-box");
    var startBtn = document.getElementById("start-btn");
    var missControls = document.getElementById("miss-controls");
    var winControls = document.getElementById("win-controls");

    var ballRadius = 10;
    var x, y, dx, dy, paddleX, score, startTime, totalPaused, pauseStart;
    var paddleWidth = 75;
    var bricks = [];
    var winImg = new Image(); winImg.src = 'Image.png';
    var missImg = new Image(); missImg.src = 'Miss.png';
    var gameState = "ready";
    var lastTouchX = null;

    function init() {
        x = canvas.width/2; y = canvas.height-30;
        dx = 2; dy = -2;
        paddleX = (canvas.width-paddleWidth)/2;
        score = 0; totalPaused = 0;
        for(var c=0; c<5; c++) {
            bricks[c] = [];
            for(var r=0; r<3; r++) { bricks[c][r] = { x: 0, y: 0, status: 1 }; }
        }
    }

    function handleMove(currentClientX) {
        if (gameState !== "play") return;
        if (lastTouchX !== null) {
            var rect = canvas.getBoundingClientRect();
            var scale = canvas.width / rect.width;
            var movementX = (currentClientX - lastTouchX) * scale;
            paddleX += movementX;
            if (paddleX < 0) paddleX = 0;
            if (paddleX > canvas.width - paddleWidth) paddleX = canvas.width - paddleWidth;
        }
        lastTouchX = currentClientX;
    }

    window.addEventListener("mousedown", function(e) { lastTouchX = e.clientX; });
    window.addEventListener("mousemove", function(e) { if(e.buttons > 0) handleMove(e.clientX); });
    window.addEventListener("mouseup", function() { lastTouchX = null; });

    window.addEventListener("touchstart", function(e) { lastTouchX = e.touches[0].clientX; }, {passive: false});
    window.addEventListener("touchmove", function(e) { 
        e.preventDefault(); 
        handleMove(e.touches[0].clientX); 
    }, {passive: false});
    window.addEventListener("touchend", function() { lastTouchX = null; });

    function startGame() {
        init();
        startTime = Date.now();
        gameState = "play";
        startBtn.style.display="none";
        msg.innerText="がんばって！";
        draw();
    }

    function continueGame() {
        // 数値をリセット
        x = canvas.width/2;
        y = canvas.height-30;
        dx = 2;
        dy = -2;
        totalPaused += (Date.now() - pauseStart);
        gameState = "play";
        missControls.style.display = "none";
        msg.innerText = "がんばって！";
        
        // 【重要】止まっていたアニメーションループを再開させる
        draw(); 
    }

    function restartGame() { location.reload(); }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        if(gameState === "play") {
            for(var c=0; c<5; c++) {
                for(var r=0; r<3; r++) {
                    var b = bricks[c][r];
                    if(b.status == 1) {
                        var bx = (c*(75+10))+30; var by = (r*(20+10))+30;
                        b.x = bx; b.y = by;
                        ctx.fillStyle = "#f06292"; ctx.fillRect(bx, by, 75, 20);
                    }
                }
            }
            ctx.beginPath(); ctx.arc(x, y, ballRadius, 0, Math.PI*2); ctx.fillStyle = "#ff4081"; ctx.fill(); ctx.closePath();
            ctx.fillStyle = "#ad1457"; ctx.fillRect(paddleX, canvas.height-10, paddleWidth, 10);

            var msec = Date.now() - startTime - totalPaused;
            var s = Math.floor(msec/1000);
            timerBox.innerText = "TIME: " + Math.floor(s/60).toString().padStart(2,'0') + ":" + (s%60).toString().padStart(2,'0');

            for(var c=0; c<5; c++) {
                for(var r=0; r<3; r++) {
                    var b = bricks[c][r];
                    if(b.status == 1 && x > b.x && x < b.x+75 && y > b.y && y < b.y+20) {
                        dy = -dy; b.status = 0; score++;
                        if(score == 15) { 
                            gameState = "win"; 
                            winControls.style.display = "block"; 
                            msg.style.display = "none"; 
                        }
                    }
                }
            }

            if(x + dx > canvas.width-ballRadius || x + dx < ballRadius) dx = -dx;
            if(y + dy < ballRadius) dy = -dy;
            else if(y + dy > canvas.height-ballRadius) {
                if(x > paddleX && x < paddleX + paddleWidth) {
                    dy = -dy;
                } else {
                    gameState = "miss";
                    pauseStart = Date.now();
                    msg.innerText = "ざんねん！";
                    missControls.style.display = "block";
                    return; // ループを止める
                }
            }
            x += dx; y += dy;
            requestAnimationFrame(draw);
        } 
        else if(gameState === "miss") {
            ctx.drawImage(missImg, 0, 0, 480, 320);
            // ここでは requestAnimationFrame を呼ばない
        } 
        else if(gameState === "win") {
            ctx.drawImage(winImg, 0, 0, 480, 320);
        }
    }
</script>
</body>
</html>
