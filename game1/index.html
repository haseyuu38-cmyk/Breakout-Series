<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>ちっくゲーム - Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { 
            margin: 0; padding: 0; background-color: #fce4ec; 
            font-family: sans-serif; display: flex; flex-direction: column; 
            align-items: center; justify-content: flex-start; min-height: 100vh;
            touch-action: none;
        }

        /* TIME表示 */
        #header-area { 
            width: 100%; height: 50px; display: none; 
            justify-content: center; align-items: center; margin-top: 5px;
        }
        #timer-box { background: #ad1457; color: white; padding: 5px 25px; border-radius: 20px; font-weight: bold; font-size: 20px; }

        /* 画像エリアの共通設定 */
        .display-area { 
            width: 95%; max-width: 480px; position: relative; 
            margin: 10px auto 0 auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden;
            background: #fff;
        }

        /* 1. トップ・セレクト画面用（縦長 2:3） */
        #screen-container { aspect-ratio: 2 / 3; display: block; }
        
        /* 2. ゲーム画面用（横長 3:2） */
        #canvas-wrapper { aspect-ratio: 3 / 2; display: none; }
        
        canvas { width: 100%; height: 100%; display: block; }
        .full-img { width: 100%; height: 100%; object-fit: contain; display: block; }
        .hit-area { position: absolute; cursor: pointer; z-index: 110; }

        /* ボタンエリア */
        #ui-area { 
            width: 90%; max-width: 480px; text-align: center;
            padding-top: 5px;
        }
        .btn { 
            display: block; width: 100%; padding: 16px; margin: 10px 0; 
            background: #ad1457; color: white; border: none; border-radius: 15px; 
            font-size: 18px; font-weight: bold; box-shadow: 0 4px 0 #78002e;
            cursor: pointer; -webkit-tap-highlight-color: transparent;
        }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #78002e; }
    </style>
</head>
<body>

<div id="header-area">
    <div id="timer-box">TIME: 00:00</div>
</div>

<div id="screen-container" class="display-area">
    <div id="top-screen" style="position:relative; width:100%; height:100%; display:block;">
        <img src="Top.png" class="full-img" alt="Top">
        <div id="go-select-hit" class="hit-area" style="top: 60%; left: 15%; width: 70%; height: 25%;" onclick="showSelect()"></div>
    </div>
    <div id="select-screen" style="position:relative; width:100%; height:100%; display:none;">
        <img src="Select.png" class="full-img" alt="Select">
        <div id="start-breakout-hit" class="hit-area" style="top: 25%; left: 10%; width: 80%; height: 20%;" onclick="startBreakout()"></div>
    </div>
</div>

<div id="canvas-wrapper" class="display-area">
    <canvas id="myCanvas" width="480" height="320"></canvas>
</div>

<div id="ui-area">
    <div id="miss-controls" style="display:none;">
        <button class="btn" onclick="continueGame()">あきらめない！</button>
        <button class="btn" style="background:#666; box-shadow:0 4px 0 #333;" onclick="restartGame()">最初からやり直す</button>
    </div>
    
    <div id="win-controls" style="display:none;">
        <button class="btn" onclick="startBreakout()">もう一度遊ぶ</button>
        <button class="btn" style="background:#e91e63; box-shadow:0 4px 0 #c2185b;" onclick="showSelect()">Game selection</button>
    </div>
</div>

<script>
    var canvas = document.getElementById("myCanvas");
    var ctx = canvas.getContext("2d");
    var timerBox = document.getElementById("timer-box");
    var headerArea = document.getElementById("header-area");
    var missControls = document.getElementById("miss-controls");
    var winControls = document.getElementById("win-controls");
    var screenContainer = document.getElementById("screen-container");
    var canvasWrapper = document.getElementById("canvas-wrapper");
    var topScreen = document.getElementById("top-screen");
    var selectScreen = document.getElementById("select-screen");

    var ballRadius = 10;
    var x, y, dx, dy, paddleX, score, startTime, totalPaused, pauseStart;
    var paddleWidth = 80;
    var bricks = [];
    var winImg = new Image(); winImg.src = 'Image.png';
    var missImg = new Image(); missImg.src = 'Miss.png';
    var gameState = "top";
    var lastTouchX = null;

    var speedMultiplier = 1.0;
    const MAX_SPEED_MULTIPLIER = 2.0;
    const SPEED_INCREMENT = 0.00015;

    function showSelect() {
        topScreen.style.display = "none";
        selectScreen.style.display = "block";
        gameState = "select";
    }

    function startBreakout() {
        screenContainer.style.display = "none";
        winControls.style.display = "none";
        missControls.style.display = "none";
        
        canvasWrapper.style.display = "block";
        headerArea.style.display = "flex";
        init();
        startTime = Date.now();
        gameState = "play";
        draw();
    }

    // セレクト画面に戻る（リセット含む）
    function showSelectFromGame() {
        canvasWrapper.style.display = "none";
        headerArea.style.display = "none";
        winControls.style.display = "none";
        missControls.style.display = "none";
        
        screenContainer.style.display = "block";
        selectScreen.style.display = "block";
        topScreen.style.display = "none";
        gameState = "select";
    }

    // ※showSelect関数を「セレクトに戻る」ボタン用に拡張
    window.showSelect = showSelectFromGame;

    function init() {
        x = canvas.width/2; y = canvas.height-30;
        dx = 2.5; dy = -2.5;
        speedMultiplier = 1.0;
        paddleX = (canvas.width-paddleWidth)/2;
        score = 0; totalPaused = 0;
        for(var c=0; c<5; c++) {
            bricks[c] = [];
            for(var r=0; r<3; r++) { bricks[c][r] = { x: 0, y: 0, status: 1 }; }
        }
    }

    function continueGame() {
        x = canvas.width/2; y = canvas.height-30;
        dx = 2.5; dy = -2.5;
        speedMultiplier = 1.0;
        totalPaused += (Date.now() - pauseStart);
        gameState = "play";
        missControls.style.display = "none";
        draw(); 
    }

    function restartGame() { location.reload(); }

    function handleMove(currentClientX) {
        if (gameState !== "play") return;
        var rect = canvas.getBoundingClientRect();
        var scale = canvas.width / rect.width;
        if (lastTouchX !== null) {
            var movementX = (currentClientX - lastTouchX) * scale;
            paddleX += movementX;
            if (paddleX < 0) paddleX = 0;
            if (paddleX > canvas.width - paddleWidth) paddleX = canvas.width - paddleWidth;
        }
        lastTouchX = currentClientX;
    }

    window.addEventListener("touchstart", function(e) { lastTouchX = e.touches[0].clientX; }, {passive: false});
    window.addEventListener("touchmove", function(e) { e.preventDefault(); handleMove(e.touches[0].clientX); }, {passive: false});
    window.addEventListener("touchend", function() { lastTouchX = null; });

    function draw() {
        if(gameState === "play") {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (speedMultiplier < MAX_SPEED_MULTIPLIER) { speedMultiplier += SPEED_INCREMENT; }
            for(var c=0; c<5; c++) {
                for(var r=0; r<3; r++) {
                    var b = bricks[c][r];
                    if(b.status == 1) {
                        var bx = (c*(75+10))+30; var by = (r*(20+10))+30;
                        b.x = bx; b.y = by;
                        ctx.fillStyle = "#f06292"; ctx.fillRect(bx, by, 75, 20);
                    }
                }
            }
            ctx.beginPath(); ctx.arc(x, y, ballRadius, 0, Math.PI*2); ctx.fillStyle = "#ff4081"; ctx.fill(); ctx.closePath();
            ctx.fillStyle = "#ad1457"; ctx.fillRect(paddleX, canvas.height-10, paddleWidth, 10);

            var msec = Date.now() - startTime - totalPaused;
            var s = Math.floor(msec/1000);
            timerBox.innerText = "TIME: " + Math.floor(s/60).toString().padStart(2,'0') + ":" + (s%60).toString().padStart(2,'0');

            for(var c=0; c<5; c++) {
                for(var r=0; r<3; r++) {
                    var b = bricks[c][r];
                    if(b.status == 1 && x > b.x && x < b.x+75 && y > b.y && y < b.y+20) {
                        dy = -dy; b.status = 0; score++;
                        if(score == 15) { 
                            gameState = "win"; 
                            winControls.style.display = "block"; 
                        }
                    }
                }
            }

            if(x + dx > canvas.width-ballRadius || x + dx < ballRadius) dx = -dx;
            if(y + dy < ballRadius) dy = -dy;
            else if(y + dy > canvas.height-ballRadius) {
                if(x > paddleX && x < paddleX + paddleWidth) { dy = -Math.abs(dy); }
                else {
                    gameState = "miss"; pauseStart = Date.now();
                    missControls.style.display = "block";
                }
            }
            x += dx * speedMultiplier; y += dy * speedMultiplier;
            requestAnimationFrame(draw);
        } 
        else if(gameState === "miss") {
            ctx.drawImage(missImg, 0, 0, 480, 320);
        } 
        else if(gameState === "win") {
            ctx.drawImage(winImg, 0, 0, 480, 320);
        }
    }
</script>
</body>
</html>
