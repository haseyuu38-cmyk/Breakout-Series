<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>ちっくゲーム - Breakout</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { 
            margin: 0; padding: 0; background-color: #fce4ec; 
            font-family: sans-serif; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; min-height: 100vh;
            touch-action: none;
        }
        #header-area { width: 100%; height: 60px; display: flex; justify-content: center; align-items: center; }
        #timer-box { background: #ad1457; color: white; padding: 5px 25px; border-radius: 20px; font-weight: bold; font-size: 22px; }

        #canvas-container { width: 95%; max-width: 480px; margin: 10px 0; position: relative; }
        canvas { background: #ffffff; display: block; width: 100%; height: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

        #ui-area { width: 90%; max-width: 480px; text-align: center; }
        .message { font-size: 20px; font-weight: bold; color: #ad1457; margin-bottom: 10px; height: 30px; }
        .btn { 
            display: block; width: 100%; padding: 18px; margin: 10px 0; 
            background: #ad1457; color: white; border: none; border-radius: 15px; 
            font-size: 18px; font-weight: bold; box-shadow: 0 4px 0 #78002e;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #78002e; }

        /* タイトル画面 */
        #title-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 100; display: flex; flex-direction: column; align-items: center;
        }
        #top-image-container { position: relative; width: 100%; }
        #top-image { width: 100%; height: auto; display: block; }
        
        /* 透明なクリック判定（STARTボタン部分） */
        .hit-area {
            position: absolute;
            left: 20%; width: 60%; height: 12%;
            cursor: pointer;
            z-index: 105;
            /* background: rgba(255,0,0,0.3); */ /* デバッグ時に位置を確認したい場合はコメントを外してください */
        }
        #start-hit { top: 58%; }

        /* ステージ選択オーバーレイ */
        #stage-select-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); z-index: 110;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

<div id="header-area">
    <div id="timer-box">TIME: 00:00</div>
</div>

<div id="canvas-container">
    <div id="title-screen">
        <div id="top-image-container">
            <img src="Top.png" id="top-image" alt="ちっくゲーム">
            <div id="start-hit" class="hit-area" onclick="showStageSelect()"></div>
        </div>

        <div id="stage-select-overlay">
            <div class="message">ステージを選んでね</div>
            <button class="btn" style="background:#ff4081;" onclick="selectStage(1)">ステージ 1 (加速あり)</button>
            <button class="btn" style="background:#ccc; box-shadow:0 4px 0 #999;" disabled>ステージ 2 (Coming Soon)</button>
            <button class="btn" style="background:#666; margin-top:20px;" onclick="hideStageSelect()">もどる</button>
        </div>
    </div>
    
    <canvas id="myCanvas" width="480" height="320"></canvas>
</div>

<div id="ui-area">
    <div id="msg" class="message"></div>
    <div id="miss-controls" style="display:none;">
        <button class="btn" onclick="continueGame()">あきらめない</button>
        <button class="btn" style="background:#666; box-shadow:0 4px 0 #333;" onclick="restartGame()">最初からやり直す</button>
    </div>
    <div id="win-controls" style="display:none;">
        <h2 style="color:#ad1457; margin-bottom:10px;">おめでとう〜♪</h2>
        <button class="btn" onclick="restartGame()">もう一度遊ぶ</button>
    </div>
</div>

<script>
    var canvas = document.getElementById("myCanvas");
    var ctx = canvas.getContext("2d");
    var msg = document.getElementById("msg");
    var timerBox = document.getElementById("timer-box");
    var missControls = document.getElementById("miss-controls");
    var winControls = document.getElementById("win-controls");
    var titleScreen = document.getElementById("title-screen");
    var stageOverlay = document.getElementById("stage-select-overlay");

    var ballRadius = 10;
    var x, y, dx, dy, paddleX, score, startTime, totalPaused, pauseStart;
    
    // 加速機能用
    var speedMultiplier = 1.0;
    const MAX_SPEED_MULTIPLIER = 2.0;
    const SPEED_INCREMENT = 0.00015;
    
    var paddleWidth = 75;
    var bricks = [];
    var winImg = new Image(); winImg.src = 'Image.png';
    var missImg = new Image(); missImg.src = 'Miss.png';
    var gameState = "title";
    var lastTouchX = null;

    function init() {
        x = canvas.width/2; y = canvas.height-30;
        dx = 2; dy = -2;
        speedMultiplier = 1.0;
        paddleX = (canvas.width-paddleWidth)/2;
        score = 0; totalPaused = 0;
        for(var c=0; c<5; c++) {
            bricks[c] = [];
            for(var r=0; r<3; r++) { bricks[c][r] = { x: 0, y: 0, status: 1 }; }
        }
    }

    function showStageSelect() { stageOverlay.style.display = "flex"; }
    function hideStageSelect() { stageOverlay.style.display = "none"; }

    function selectStage(num) {
        titleScreen.style.display = "none";
        init();
        startTime = Date.now();
        gameState = "play";
        msg.innerText = "がんばって！";
        draw();
    }

    function continueGame() {
        x = canvas.width/2; y = canvas.height-30;
        dx = 2; dy = -2;
        speedMultiplier = 1.0; // 加速リセット
        totalPaused += (Date.now() - pauseStart);
        gameState = "play";
        missControls.style.display = "none";
        msg.innerText = "がんばって！";
        draw(); 
    }

    function restartGame() { location.reload(); }

    function handleMove(currentClientX) {
        if (gameState !== "play") return;
        if (lastTouchX !== null) {
            var rect = canvas.getBoundingClientRect();
            var scale = canvas.width / rect.width;
            var movementX = (currentClientX - lastTouchX) * scale;
            paddleX += movementX;
            if (paddleX < 0) paddleX = 0;
            if (paddleX > canvas.width - paddleWidth) paddleX = canvas.width - paddleWidth;
        }
        lastTouchX = currentClientX;
    }

    window.addEventListener("mousedown", function(e) { lastTouchX = e.clientX; });
    window.addEventListener("mousemove", function(e) { if(e.buttons > 0) handleMove(e.clientX); });
    window.addEventListener("mouseup", function() { lastTouchX = null; });
    window.addEventListener("touchstart", function(e) { lastTouchX = e.touches[0].clientX; }, {passive: false});
    window.addEventListener("touchmove", function(e) { e.preventDefault(); handleMove(e.touches[0].clientX); }, {passive: false});
    window.addEventListener("touchend", function() { lastTouchX = null; });

    function draw() {
        if(gameState === "play") {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 加速ロジック
            if (speedMultiplier < MAX_SPEED_MULTIPLIER) {
                speedMultiplier += SPEED_INCREMENT;
            }

            for(var c=0; c<5; c++) {
                for(var r=0; r<3; r++) {
                    var b = bricks[c][r];
                    if(b.status == 1) {
                        var bx = (c*(75+10))+30; var by = (r*(20+10))+30;
                        b.x = bx; b.y = by;
                        ctx.fillStyle = "#f06292"; ctx.fillRect(bx, by, 75, 20);
                    }
                }
            }
            ctx.beginPath(); ctx.arc(x, y, ballRadius, 0, Math.PI*2); ctx.fillStyle = "#ff4081"; ctx.fill(); ctx.closePath();
            ctx.fillStyle = "#ad1457"; ctx.fillRect(paddleX, canvas.height-10, paddleWidth, 10);

            var msec = Date.now() - startTime - totalPaused;
            var s = Math.floor(msec/1000);
            timerBox.innerText = "TIME: " + Math.floor(s/60).toString().padStart(2,'0') + ":" + (s%60).toString().padStart(2,'0');

            for(var c=0; c<5; c++) {
                for(var r=0; r<3; r++) {
                    var b = bricks[c][r];
                    if(b.status == 1 && x > b.x && x < b.x+75 && y > b.y && y < b.y+20) {
                        dy = -dy; b.status = 0; score++;
                        if(score == 15) { 
                            gameState = "win"; 
                            winControls.style.display = "block"; 
                            msg.style.display = "none"; 
                        }
                    }
                }
            }

            if(x + dx > canvas.width-ballRadius || x + dx < ballRadius) dx = -dx;
            if(y + dy < ballRadius) dy = -dy;
            else if(y + dy > canvas.height-ballRadius) {
                if(x > paddleX && x < paddleX + paddleWidth) {
                    dy = -Math.abs(dy);
                } else {
                    gameState = "miss"; pauseStart = Date.now();
                    msg.innerText = "ざんねん！"; missControls.style.display = "block";
                    ctx.drawImage(missImg, 0, 0, 480, 320); return; 
                }
            }
            
            x += dx * speedMultiplier; y += dy * speedMultiplier;
            requestAnimationFrame(draw);
        } else if(gameState === "miss") {
            ctx.drawImage(missImg, 0, 0, 480, 320);
        } else if(gameState === "win") {
            ctx.drawImage(winImg, 0, 0, 480, 320);
        }
    }
</script>
</body>
</html>
